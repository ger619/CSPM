<!-- app/views/data_center/orm_report.html.erb -->

<h1 class="flex justify-center text-2xl font-bold mb-4">ORM Report</h1>
<div class="p-2 w-full">
  <%= form_with url: orm_report_path, method: :get, local: true do |f| %>
    <div class="flex flex-wrap justify-center gap-2">
      <div class="flex flex-col gap-2 w-full sm:w-1/6 md:w-1/6">
        <%= f.label :start_date, "Start Date" %>
        <%= f.date_field :start_date, value: params[:start_date] %>
      </div>
      <div class="flex flex-col gap-2 w-full sm:w-1/6 md:w-1/6">
        <%= f.label :end_date, "End Date" %>
        <%= f.date_field :end_date, value: params[:end_date] %>
      </div>
      <div class="flex flex-col gap-2 w-full sm:w-1/6 md:w-1/6">
        <%= f.label :days, "Show Closed & Resolved (days)" %>
        <%= f.number_field :days, value: params[:days] %>
      </div>
      <div class="flex flex-col gap-2 w-full sm:w-1/6 md:w-1/6">
        <%= f.label :client_id, "Client" %>
        <% if current_user.has_role?(:admin) || current_user.has_role?(:observer) %>
          <%= f.collection_select :client_id, Client.all, :id, :name, include_blank: true %>
        <% else %>
          <%= f.collection_select :client_id, Client.joins(:projects).where(projects: { id: current_user.projects.ids }).distinct, :id, :name, include_blank: true %>
        <% end %>
      </div>
      <div class="flex flex-col gap-2 w-full sm:w-1/6 md:w-1/6 pt-9">
        <%= f.submit "Generate Report", class: 'bg-[#3F8CFF] hover:bg-[#3A81EB] p-2 rounded font-bold rounded-lg text-slate-100 w-full sm:w-auto' %>
      </div>
    </div>
  <% end %>
</div>

<% if @tickets.present? %>
  <div class="container mx-auto mb-4 px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-end">
      <%= link_to "Download CSV",
                  orm_report_path(format: :csv, start_date: params[:start_date], end_date: params[:end_date], client_id: params[:client_id], status: params[:status]),
                  class: "mb-4 mt-4 h-12 bg-[#3F8CFF] hover:bg-[#3A81EB] p-3 rounded font-bold rounded-lg text-slate-100" %>
    </div>
    <table id="orm_report" class="table-auto w-full">
      <thead>
      <tr>
        <th class="border border-black px-4 py-2">Created at</th>
        <th class="border border-black px-4 py-2">Project Name</th>
        <th class="border border-black px-4 py-2">Ticket ID</th>
        <th class="border border-black px-4 py-2">Issue Type</th>
        <th class="border border-black px-4 py-2">Summary</th>
        <th class="border border-black px-4 py-2">Status</th>
        <th class="border border-black px-4 py-2">Severity</th>
        <th class="border border-black px-4 py-2">Assignee</th>
        <th class="border border-black px-4 py-2">Reporter</th>
        <th class="border border-black px-4 py-2">Details</th>
      </tr>
      </thead>
      <tbody>
      <% @tickets.each do |ticket| %>
        <% row_class = case ticket.statuses.first&.name
                       when 'New'
                         'bg-red-500'
                       when 'Closed', 'Resolved'
                         'bg-green-500'
                       when 'Reopened'
                         'bg-red-900'
                       when 'Under Development'
                         'bg-blue-300'
                       when 'Work in Progress'
                         'bg-gray-500'
                       when 'QA Testing'
                         'bg-pink-500'
                       when 'Awaiting Build'
                         'bg-gray-800'
                       when 'Client Confirmation Pending'
                         'bg-purple-500'
                       when 'On-Hold'
                         'bg-yellow-300'
                       when 'Assigned'
                         'bg-blue-800'
                       when 'Declined'
                         'bg-gray-800'
                       when 'Approved'
                         'bg-green-700'
                       when 'Pending'
                         'bg-gradient-to-r from-red-800 to-green-800'
                       else
                         ''
                       end %>
        <tr class="<%= row_class %> text-white text-bold">
          <td class="border px-4 py-2"><%= ticket.created_at.strftime("%d-%b-%Y") %></td>
          <td class="capitalize border px-4 py-2"><%= ticket.project.title %></td>
          <td class="border px-4 py-2"><%= ticket.unique_id %></td>
          <td class="border px-4 py-2"><%= ticket.subject %></td>
          <td class="border px-4 py-2"><%= ticket.issue %></td>
          <td class="border px-4 py-2"><%= ticket.statuses.first&.name || 'N/A' %></td>
          <td class="border px-4 py-2"><%= ticket.priority %></td>
          <td class="border px-4 py-2"><%= ticket.users.map(&:name).select(&:present?).join(', ') %></td>
          <td class="border px-4 py-2"><%= ticket.user.name %></td>
          <td class="border px-4 py-2"><%= ticket.content.to_plain_text.truncate(800) %></td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>
<% end %>