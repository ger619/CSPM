<!-- app/views/data_center/project_report.html.erb -->
<h1 class="flex justify-center text-2xl font-bold mb-4">Project Report</h1>
<div class="p-2 w-full">
<%= form_with url: project_report_path, method: :get, local: true do %>
    <div class="flex flex-wrap justify-center gap-2">
      <div class="flex flex-col gap-2 w-full sm:w-1/2 md:w-1/3">
  <%= label_tag :project_id, 'Select Project', class: "capitalize text-sm font-bold w-full align-middle pt-2" %>

  <div class="relative w-full">
    <!-- Searchable Input -->
      <input type="text" id="searchProject" class="border border-[#3F8CFF] hover:border-[#3A81EB] border-2 rounded-lg dark:text-black w-full p-2" placeholder="Search Project..." onclick="showDropdown()" onkeyup="filterProjectDropdown()">

      <!-- Dropdown List -->
      <div id="projectDropdown" class="absolute w-full bg-white border rounded-lg mt-1 shadow-lg max-h-40 overflow-y-auto hidden">
        <% projects = if current_user.has_role?(:admin) || current_user.has_role?(:observer)
                        Project.all
                      else
                        current_user.projects
                      end %>
        <% projects.each do |project| %>
          <div class="dropdown-item px-4 py-2 hover:bg-gray-100 cursor-pointer" data-project-id="<%= project.id %>" onclick="selectProject(this)">
            <%= project.title %>
          </div>
        <% end %>
      </div>

      <!-- Hidden Input to store selected project ID -->
      <input type="hidden" id="selectedProjectId" name="project_id" required>
    </div>
  </div>
      <div class="flex flex-col gap-2 w-full sm:w-1/2 md:w-1/3">
        <%= label_tag :start_date, 'Start Date', class: "capitalize text-sm font-bold w-full align-middle pt-2" %>
        <%= date_field_tag :start_date, params[:start_date], class: "border border-[#3F8CFF] hover:border-[#3A81EB] border-2 rounded-lg dark:text-black w-full p-2" %>
      </div>
      <div class="flex flex-col gap-2 w-full sm:w-1/2 md:w-1/3">
        <%= label_tag :end_date, 'End Date' , class: "capitalize text-sm font-bold w-full align-middle pt-2" %>
        <%= date_field_tag :end_date, params[:end_date], class: "border border-[#3F8CFF] hover:border-[#3A81EB] border-2 rounded-lg dark:text-black w-full p-2"  %>
      </div>
      <div class="flex flex-col gap-2 w-full sm:w-1/2 md:w-1/3 pt-9">
        <%= submit_tag 'Show Report', class: 'bg-[#3F8CFF] hover:bg-[#3A81EB] p-2 rounded font-bold rounded-lg text-slate-100 w-full sm:w-auto' %>
      </div>
  <% end %>
  </div>
</div>

<div class="container mx-auto mb-4 px-4 sm:px-6 lg:px-8 py-8">
<% if @project %>
  <div class="flex justify-center">
    <h2>
      Project Report for <%= @project.title %>
    </h2>
    <%= link_to 'Download CSV Report', project_report_path(format: :csv, project_id: @project.id, start_date: params[:start_date], end_date: params[:end_date]), class: 'btn btn-primary' %>
  </div>
    <div class="flex mx-auto justify-center">
  <% if @tickets_by_user.present? %>
    <table>
      <thead>
      <tr>
        <th>User Name</th>
        <th>Ticket Count</th>
      </tr>
      </thead>
      <tbody>
      <% @tickets_by_user.each do |user_id, ticket_count| %>
        <% user = User.find(user_id) %>
        <tr>
          <td class="border border-black dark:border-slate-100 px-4 py-2"><%= user.name %></td>
          <td class="border border-black dark:border-slate-100 px-4 py-2"><%= ticket_count %></td>
        </tr>
      <% end %>
      </tbody>
    </table>
  <% else %>
    <p>No tickets found for the selected date range.</p>
  <% end %>
<% end %>
  </div>
</div>

<script>
  function showDropdown() {
    document.getElementById("projectDropdown").classList.remove("hidden");
  }

  function hideDropdown(event) {
    if (!event.target.closest(".relative")) {
      document.getElementById("projectDropdown").classList.add("hidden");
    }
  }

  function filterProjectDropdown() {
    let input = document.getElementById("searchProject").value.toLowerCase();
    let dropdown = document.getElementById("projectDropdown");
    let items = dropdown.getElementsByClassName("dropdown-item");

    dropdown.classList.remove("hidden");

    let hasMatch = false;
    for (let item of items) {
      let text = item.textContent.toLowerCase();
      if (text.includes(input)) {
        item.style.display = "block";
        hasMatch = true;
      } else {
        item.style.display = "none";
      }
    }

    if (!hasMatch) {
      dropdown.classList.add("hidden");
    }
  }

  function selectProject(element) {
    let projectTitle = element.textContent.trim();
    let projectId = element.getAttribute("data-project-id");

    let inputField = document.getElementById("searchProject");
    inputField.value = projectTitle;
    inputField.style.paddingRight = "12px"; // Prevents text from being cut off
    inputField.style.overflow = "visible"; // Ensures full visibility

    document.getElementById("selectedProjectId").value = projectId;
    document.getElementById("projectDropdown").classList.add("hidden");
  }

  document.addEventListener("click", function(event) {
    let dropdown = document.getElementById("projectDropdown");
    let searchInput = document.getElementById("searchProject");

    if (!searchInput.contains(event.target) && !dropdown.contains(event.target)) {
      dropdown.classList.add("hidden");
    }
  });
</script>
